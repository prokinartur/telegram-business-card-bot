package main

// --- –ò–ú–ü–û–†–¢–´ (–ò–ù–°–¢–†–£–ú–ï–ù–¢–´) ---
import (
	"fmt"                  // –î–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫ (fmt.Sprintf)
	"hello_world/telegram" // –ù–∞—à "–ø—É–ª—å—Ç" (–ø–∞–∫–µ—Ç telegram)
	"log"                  // –î–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫ (log.Printf/Fatalf)
	"os"                   // –î–ª—è —á—Ç–µ–Ω–∏—è "–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è" (os.Getenv)
	"strconv"              // –î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫ –≤ —á–∏—Å–ª–∞ (strconv.Atoi)
	"strings"              // –î–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ (strings.TrimSpace)
	"time"                 // –î–ª—è time.Sleep(1 * time.Second)

	"github.com/joho/godotenv" // –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ .env
)

// ... (–∏–º–ø–æ—Ä—Ç—ã)

// --- 1. üí° –ß–ï–†–¢–ï–ñ "–£–°–õ–£–ì–ò" (–ù–û–í–´–ô STRUCT)
// –û–ø–∏—Å—ã–≤–∞–µ—Ç "–∫—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è –∏ –¶–µ–Ω—É
type TaxInfo struct {
	Name  string // "–ö—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–£–°–ù –î–æ—Ö–æ–¥—ã 6%")
	Price int    // –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000)
}

// --- 2. üí° –ù–ê–® "–¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –ü–†–ê–ô–°-–õ–ò–°–¢" (–ù–û–í–´–ô MAP)
// –ú—ã "—Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º" "—Å–µ–∫—Ä–µ—Ç–Ω—É—é" –∫–æ–º–∞–Ω–¥—É (tax_6) —Å "—á–µ—Ä—Ç–µ–∂–æ–º" (TaxInfo)
var taxSystemConfig = map[string]TaxInfo{
	// --- –ö–ª—é—á ---    --- –ó–Ω–∞—á–µ–Ω–∏–µ (–ò–º—è, –¶–µ–Ω–∞) ---
	"tax_6":      {Name: "–£–°–ù –î–æ—Ö–æ–¥—ã 6%", Price: 5000},
	"tax_15":     {Name: "–£–°–ù –î–æ—Ö-–†–∞—Å—Ö 15%", Price: 8000},
	"tax_osno":   {Name: "–û–°–ù–û", Price: 10000},
	"tax_patent": {Name: "–ü–∞—Ç–µ–Ω—Ç (–¥–ª—è –ò–ü)", Price: 5000}, // (–¢—ã —É–∫–∞–∑–∞–ª 5000, –Ω–æ –º—ã –º–æ–∂–µ–º –ª–µ–≥–∫–æ –ø–æ–º–µ–Ω—è—Ç—å)
}

// ... (–¢–≤–æ–π struct UserCalculation –∏ map userCalculations –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)

// "–ß–ï–†–¢–ï–ñ" –ê–ù–ö–ï–¢–´ (PRO)
// UserCalculation –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –í–°–ï –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
type UserCalculation struct {

	// --- –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ ---
	CurrentStep   int    // –ù–∞ –∫–∞–∫–æ–º —à–∞–≥–µ –æ–Ω —Å–µ–π—á–∞—Å (0, 1, 2...)
	ClientType    string // "–ò–ü" –∏–ª–∏ "–û–û–û"
	TaxSystem     string // "tax_6", "tax_15", "tax_osno" (–°–ù–û)
	HasPatent     bool   // –ï—Å—Ç—å –ª–∏ –ø–∞—Ç–µ–Ω—Ç (true/false)
	Employees     int    // –ö–æ–ª-–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
	TaxSystemName string // "–ö—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è (–£–°–ù –î–æ—Ö–æ–¥—ã 6%)

	// --- –î–∞–Ω–Ω—ã–µ –¥–ª—è –†–∞—Å—á–µ—Ç–∞ ---
	BasePrice     int // –ò—Ç–æ–≥–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ –°–ù–û
	EmployeePrice int // –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
	FinalPrice    int // –ü–æ–ª–Ω–∞—è –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞
}

var userCalculations = make(map[int64]*UserCalculation) // –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–ø–æ–Ω–∏–º–Ω–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –ö–ª—é—á —ç—Ç–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ UserCalculation.

// --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–¢–û–ß–ö–ê –í–•–û–î–ê) ---
func main() {
	// 1. –ó–ê–ì–†–£–ó–ö–ê –°–ï–ö–†–ï–¢–û–í (.env)
	// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª .env, —á—Ç–æ–±—ã os.Getenv() –º–æ–≥ "—É–≤–∏–¥–µ—Ç—å" BOT_TOKEN
	err := godotenv.Load()
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ .env —Ñ–∞–π–ª–∞: %v", err)
	}

	// 2. –ß–¢–ï–ù–ò–ï –°–ï–ö–†–ï–¢–û–í
	// –ß–∏—Ç–∞–µ–º —Ç–æ–∫–µ–Ω "–∏–∑–≤–Ω–µ" (–∏–∑ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã)
	BOT_TOKEN := os.Getenv("BOT_TOKEN")
	if BOT_TOKEN == "" {
		log.Fatalf("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!")
	}

	// 3. –°–û–ó–î–ê–ù–ò–ï "–ü–£–õ–¨–¢–ê"
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—à "–ø—É–ª—å—Ç" (–ö–ª–∏–µ–Ω—Ç) —Å —Ç–æ–∫–µ–Ω–æ–º
	client := telegram.NewClient(BOT_TOKEN)

	// 4. –°–ß–ï–¢–ß–ò–ö (OFFSET)
	// updateOffset —Ö—Ä–∞–Ω–∏—Ç ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ "—É—Å–ª—ã—à–∞–Ω–Ω–æ–≥–æ" —Å–æ–æ–±—â–µ–Ω–∏—è,
	// —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞.
	updateOffset := 0

	fmt.Println("ü§ñ –ë–æ—Ç-–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–ü—Ä–æ–µ–∫—Ç 3) –∑–∞–ø—É—â–µ–Ω...")

	// 5. –í–ï–ß–ù–´–ô –¶–ò–ö–õ (–°–ï–†–î–¶–ï –ë–û–¢–ê)
	for {
		// 5.1 "–°–ª—É—à–∞–µ–º" Telegram (—Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
		// –ü–µ—Ä–µ–¥–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è
		updates, err := client.GetUpdates(updateOffset)
		if err != nil {
			log.Printf("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: %v", err)
		}

		// 5.2 –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º "–ø–∞—á–∫—É" –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ 0, 1 –∏–ª–∏ 100)
		for _, update := range updates {
			// 5.3 –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–î–∏—Å–ø–µ—Ç—á–µ—Ä—É"
			if err := processUpdate(client, update); err != nil {
				log.Printf("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: %v", err)
			}

			// 5.4 –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
			// "–Ø –≤–∏–¥–µ–ª —ç—Ç–æ (update.ID). –í —Å–ª–µ–¥. —Ä–∞–∑ –¥–∞–π –º–Ω–µ update.ID + 1"
			updateOffset = update.ID + 1
		}

		// 5.5 –°–æ–Ω
		// –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É, —á—Ç–æ–±—ã –Ω–µ "—Å–ø–∞–º–∏—Ç—å" Telegram
		time.Sleep(1 * time.Second)
	}
}

// ---
// üí° "–î–ò–°–ü–ï–¢–ß–ï–†" (–ì–ª–∞–≤–Ω—ã–π –º–æ–∑–≥)
// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ—à–∞–µ—Ç, –ö–£–î–ê –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
// –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ö–ù–û–ü–ö–ò –∏–ª–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¢–ï–ö–°–¢–ê.
// ---
func processUpdate(client *telegram.Client, update telegram.Update) error {
	// 1. –ü–†–û–í–ï–†–ö–ê –ù–ê–ñ–ê–¢–ò–Ø –ö–ù–û–ü–ö–ò
	// –ï—Å–ª–∏ –ø–æ–ª–µ CallbackQuery (–Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏) –Ω–µ –ø—É—Å—Ç–æ–µ...
	if update.CallbackQuery != nil {
		// ...–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –≤ "–†–æ—É—Ç–µ—Ä –ö–Ω–æ–ø–æ–∫"
		return processCallbackQuery(client, update.CallbackQuery)
	}

	// 2. –ü–†–û–í–ï–†–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø
	// –ï—Å–ª–∏ –ø–æ–ª–µ Message (—Ç–µ–∫—Å—Ç) –Ω–µ –ø—É—Å—Ç–æ–µ...
	if update.Message != nil {
		// ...–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –≤ "–†–æ—É—Ç–µ—Ä –¢–µ–∫—Å—Ç–∞"
		return processMessage(client, update.Message)
	}

	// 3. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ (—Ä–µ–∞–∫—Ü–∏–∏, —Å—Ç–∏–∫–µ—Ä—ã –∏ —Ç.–¥.)
	return nil
}

// üí° "–†–û–£–¢–ï–† 1" (–û–±—Ä–∞–±–æ—Ç–∫–∞ –¢–ï–ö–°–¢–ê: /start, /price, "2")
func processMessage(client *telegram.Client, message *telegram.Message) error {
	chatID := message.Chat.ID
	text := message.Text

	command := strings.TrimSpace(strings.ToLower(text))
	var responseText string // –ì–æ—Ç–æ–≤–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –æ—Ç–≤–µ—Ç–∞

	// 1. üí° –ü–´–¢–ê–ï–ú–°–Ø –ü–û–õ–£–ß–ò–¢–¨ "–ê–ù–ö–ï–¢–£" –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ò–ó "–ü–ê–ú–Ø–¢–ò"
	// –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º "calcExists" (true/false), —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å,
	// –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞—Å—á–µ—Ç–∞.
	calc, calcExists := userCalculations[chatID]

	// 2. –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î (switch)
	switch command {
	case "/start":
		// 1. üí° –°–û–ó–î–ê–ï–ú –ù–û–í–£–Æ "–ê–ù–ö–ï–¢–£" (–£–º–Ω–∞—è –ü–∞–º—è—Ç—å)
		// –ú—ã —Å–æ–∑–¥–∞–µ–º *–Ω–æ–≤—É—é* –∞–Ω–∫–µ—Ç—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		calc = &UserCalculation{
			CurrentStep: 1, // üëà –°—Ç–∞–≤–∏–º –®–∞–≥ 1 (–ù–æ–≤—ã–π –¢–ó: –í—ã–±–æ—Ä –ò–ü/–û–û–û)
		}
		// 2. üí° –°–û–•–†–ê–ù–Ø–ï–ú –ê–ù–ö–ï–¢–£ –í "–ü–ê–ú–Ø–¢–¨" (Map)
		userCalculations[chatID] = calc

		// 3. üí° –ù–û–í–´–ï –ö–ù–û–ü–ö–ò (–®–∞–≥ 1: –ò–ü/–û–û–û –∏–∑ —Ç–≤–æ–µ–≥–æ –¢–ó)
		markup := telegram.InlineKeyboardMarkup{
			InlineKeyboard: [][]telegram.InlineKeyboardButton{
				{ // –†—è–¥ 1
					{Text: "–ò–ü (–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å)", CallbackData: "client_ip"},
				},
				{ // –†—è–¥ 2
					{Text: "–û–û–û (–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)", CallbackData: "client_ooo"},
				},
			},
		}
		responseText = "ü§ñ –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞.\n\n–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞—Å—á–µ—Ç, –≤—ã–±–µ—Ä–∏—Ç–µ –í–∞—à—É —Ñ–æ—Ä–º—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:"
		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –° –ö–ù–û–ü–ö–ê–ú–ò
		return client.SendMessageWithButtons(chatID, responseText, &markup)

	case "/price":
		responseText = "‚≠êÔ∏è **–ü—Ä–∞–π—Å-–ª–∏—Å—Ç...**" // (–≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
		return client.SendMessage(chatID, responseText, nil)

	case "/links":
		responseText = "üîó **–ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã...**" // (–≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
		return client.SendMessage(chatID, responseText, nil)

	// 3. –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–ö–°–¢–ê (–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞)
	default:
		// üí° –ü–†–û–í–ï–†–ö–ê: –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ "–ê–Ω–∫–µ—Ç–∞" –∏ –Ω–∞ –∫–∞–∫–æ–º –æ–Ω–∞ "–®–∞–≥–µ"?
		// –ú—ã "–ª–æ–≤–∏–º" –æ—Ç–≤–µ—Ç –Ω–∞ –®–∞–≥ 3 (–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)
		if calcExists && calc.CurrentStep == 3 {

			// --- (–≠—Ç–æ—Ç –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ) ---
			numEmployees, err := strconv.Atoi(text)
			if err != nil || numEmployees < 0 {
				responseText = "üö´ –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 0, 1, 2...)."
				return client.SendMessage(chatID, responseText, nil)
			}
			// ---

			// üí° –°–û–•–†–ê–ù–Ø–ï–ú –í "–ê–ù–ö–ï–¢–£" (–£–º–Ω–∞—è –ü–∞–º—è—Ç—å)
			calc.Employees = numEmployees

			// üí° –§–ò–ù–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ (–ü–æ–∫–∞ "–ó–∞–≥–ª—É—à–∫–∞")
			// (–ü–æ–∑–∂–µ –º—ã –±—É–¥–µ–º –±—Ä–∞—Ç—å BasePrice –∏–∑ –∞–Ω–∫–µ—Ç—ã,
			// –∫–æ—Ç–æ—Ä—É—é –∑–∞–ø–æ–ª–Ω–∏–º –Ω–∞ –®–∞–≥–µ 2)
			basePrice := 3000
			employeePrice := calc.Employees * 2000
			finalPrice := basePrice + employeePrice

			// üí° –°–û–•–†–ê–ù–Ø–ï–ú –†–ê–°–ß–ï–¢ –í "–ê–ù–ö–ï–¢–£"
			calc.BasePrice = basePrice
			calc.EmployeePrice = employeePrice
			calc.FinalPrice = finalPrice

			// üí° –°–ë–†–û–°! –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–∫–æ–Ω—á–∏–ª.
			// –£–¥–∞–ª—è–µ–º "–ê–Ω–∫–µ—Ç—É" –∏–∑ "–ü–∞–º—è—Ç–∏", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞.
			delete(userCalculations, chatID)

			// –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
			responseText := fmt.Sprintf(
				"‚úÖ **–†–ê–°–ß–ï–¢ –ó–ê–í–ï–†–®–ï–ù!**\n\n"+
					"**–°–∏—Å—Ç–µ–º–∞:** %s\n"+ // üëà (–ò—Å–ø–æ–ª—å–∑—É–µ–º "–ö—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è)
					"**–í—ã –≤–≤–µ–ª–∏:** %d —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.\n\n"+
					"–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏: %d —Ä—É–±.\n"+
					"–î–æ–ø–ª–∞—Ç–∞ –∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: %d —Ä—É–±.\n\n"+
					"üí∞ **–ò–¢–û–ì–û: %d —Ä—É–±.**\n\n"+
					"–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ /start",
				calc.TaxSystemName, // üëà (–ù–∞–ø—Ä–∏–º–µ—Ä, "–£–°–ù –î–æ—Ö–æ–¥—ã 6%")
				calc.Employees,
				calc.BasePrice,
				calc.EmployeePrice,
				finalPrice)

			return client.SendMessage(chatID, responseText, nil)

		} // –ö–æ–Ω–µ—Ü if calc.CurrentStep == 3

		// –ï—Å–ª–∏ –º—ã –Ω–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –æ–ø–æ–∑–Ω–∞–Ω–∞
		responseText = "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –≤–∞—Å –Ω–µ –ø–æ–Ω—è–ª. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –Ω–∞–±–µ—Ä–∏—Ç–µ /start"
		return client.SendMessage(chatID, responseText, nil)
	}
}

// main/main.go

// main/main.go

func processCallbackQuery(client *telegram.Client, query *telegram.CallbackQuery) error {

	go client.AnswerCallbackQuery(query.ID)

	chatID := query.Message.Chat.ID
	data := query.Data

	calc, calcExists := userCalculations[chatID]
	if !calcExists {
		return nil
	}

	switch calc.CurrentStep {
	// ---
	// üí° –û–ë–†–ê–ë–û–¢–ö–ê –®–ê–ì–ê 1 (–û—Ç–≤–µ—Ç –Ω–∞ "–ò–ü" / "–û–û–û")
	// ---
	case 1:
		calc.ClientType = data
		calc.CurrentStep = 2

		// üí° –ì–æ—Ç–æ–≤–∏–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –®–∞–≥–∞ 2 (–°–ù–û)
		// –ú—ã "—Å—Ç—Ä–æ–∏–º" –∫–Ω–æ–ø–∫–∏, "—á–∏—Ç–∞—è" –Ω–∞—à "–ü—Ä–∞–π—Å-–õ–∏—Å—Ç" (Config)
		var markup telegram.InlineKeyboardMarkup
		var keyboardRows [][]telegram.InlineKeyboardButton

		// "–ü—Ä–æ–±–µ–≥–∞–µ–º" –ø–æ –≤—Å–µ–º –∫–ª—é—á–∞–º (tax_6, tax_15...) –≤ –ü—Ä–∞–π—Å-–õ–∏—Å—Ç–µ
		for key, info := range taxSystemConfig {
			// (–¢–ó: "–û–û–û" –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å "–ü–∞—Ç–µ–Ω—Ç")
			if calc.ClientType == "client_ooo" && key == "tax_patent" {
				continue // üëà "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º" –ü–∞—Ç–µ–Ω—Ç –¥–ª—è –û–û–û
			}

			// –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –ò–º—è = "–ö—Ä–∞—Å–∏–≤–æ–µ" (info.Name), –ö–æ–º–∞–Ω–¥–∞ = "–°–µ–∫—Ä–µ—Ç" (key)
			button := telegram.InlineKeyboardButton{
				Text:         info.Name,
				CallbackData: key,
			}
			// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É (–∫–∞–∂–¥—É—é –≤ —Å–≤–æ–π —Ä—è–¥)
			keyboardRows = append(keyboardRows, []telegram.InlineKeyboardButton{button})
		}

		markup.InlineKeyboard = keyboardRows

		var responseText string
		if calc.ClientType == "client_ip" {
			responseText = "–í—ã –≤—ã–±—Ä–∞–ª–∏ **–ò–ü**. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –í–∞—à—É —Å–∏—Å—Ç–µ–º—É –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è:"
		} else {
			responseText = "–í—ã –≤—ã–±—Ä–∞–ª–∏ **–û–û–û**. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –í–∞—à—É —Å–∏—Å—Ç–µ–º—É –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è:"
		}

		return client.SendMessageWithButtons(chatID, responseText, &markup)

	// ---
	// üí° –û–ë–†–ê–ë–û–¢–ö–ê –®–ê–ì–ê 2 (–û—Ç–≤–µ—Ç –Ω–∞ "–°–ù–û": "tax_6", "tax_15"...)
	// ---
	case 2:
		// 1. üí° "–ß–ò–¢–ê–ï–ú" –ò–ó "–ü–†–ê–ô–°-–õ–ò–°–¢–ê"
		// –ú—ã "–∏—â–µ–º" –≤ –Ω–∞—à–µ–º "–ü—Ä–∞–π—Å-–õ–∏—Å—Ç–µ" (Config) –ø–æ "—Å–µ–∫—Ä–µ—Ç–Ω–æ–π" –∫–æ–º–∞–Ω–¥–µ (data)
		taxInfo, ok := taxSystemConfig[data]
		if !ok {
			// –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ "—Å–ª–æ–º–∞–Ω–Ω–∞—è" –∫–Ω–æ–ø–∫–∞ (–∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ "–ü—Ä–∞–π—Å-–õ–∏—Å—Ç–µ")
			return client.SendMessage(chatID, "–û—à–∏–±–∫–∞: —Ç–∞–∫–∞—è —É—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ —Å /start", nil)
		}

		// 2. üí° "–ó–ê–ü–û–ú–ò–ù–ê–ï–ú" –í–°–ï –í "–ê–ù–ö–ï–¢–£" (–£–º–Ω–∞—è –ü–∞–º—è—Ç—å)
		calc.TaxSystem = data             // "–°–µ–∫—Ä–µ—Ç–Ω—ã–π" –∫–ª—é—á (tax_6)
		calc.TaxSystemName = taxInfo.Name // "–ö—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è (–£–°–ù –î–æ—Ö–æ–¥—ã 6%)
		calc.BasePrice = taxInfo.Price    // "–¶–µ–Ω—É" (5000)

		// 3. –ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –®–∞–≥ 3 (–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)
		calc.CurrentStep = 3

		// 4. –ó–∞–¥–∞–µ–º –≤–æ–ø—Ä–æ—Å (–∏—Å–ø–æ–ª—å–∑—É—è "–ö—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è)
		responseText := fmt.Sprintf(
			"–û—Ç–ª–∏—á–Ω–æ, –í—ã –≤—ã–±—Ä–∞–ª–∏ **%s** (–ë–∞–∑–∞: %d —Ä—É–±).\n\n"+
				"–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å: **–°–∫–æ–ª—å–∫–æ —É –≤–∞—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤?** (–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ)",
			calc.TaxSystemName, // üëà (–ò—Å–ø–æ–ª—å–∑—É–µ–º "–ö—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è)
			calc.BasePrice,
		)

		return client.SendMessage(chatID, responseText, nil)
	}

	return nil
}
