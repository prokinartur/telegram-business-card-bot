package main

import (
	"fmt"
	"hello_world/telegram"
	"log"
	"os" // üëà –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¥–ª—è —á—Ç–µ–Ω–∏—è "–∏–∑–≤–Ω–µ"
	"strings"
	"time"

	"github.com/joho/godotenv" // üëà –ù–û–í–´–ô –ò–ú–ü–û–†–¢
)

// const BOT_TOKEN = "..." // üëà –£–î–ê–õ–Ø–ï–ú –≠–¢–£ –°–¢–†–û–ö–£!

func main() {
	// üí° –ù–Æ–ê–ù–° 1: –ó–∞–≥—Ä—É–∂–∞–µ–º "—Å–µ–∫—Ä–µ—Ç—ã" –∏–∑ .env
	err := godotenv.Load() // üëà –ò—â–µ—Ç —Ñ–∞–π–ª .env
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ .env —Ñ–∞–π–ª–∞: %v", err)
	}

	// üí° –ù–Æ–ê–ù–° 2: –ß–∏—Ç–∞–µ–º "—Å–µ–∫—Ä–µ—Ç"
	BOT_TOKEN := os.Getenv("BOT_TOKEN") // üëà –ß–∏—Ç–∞–µ–º —Ç–æ–∫–µ–Ω "–∏–∑–≤–Ω–µ"
	if BOT_TOKEN == "" {
		log.Fatalf("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!")
	}

	// 1. –°–æ–∑–¥–∞–µ–º "–ü—É–ª—å—Ç"
	client := telegram.NewClient(BOT_TOKEN)

	// Offset
	// –≠—Ç–æ "—Å—á–µ—Ç—á–∏–∫", –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç ID *–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ* –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è,
	// –∫–æ—Ç–æ—Ä–æ–µ –º—ã –≤–∏–¥–µ–ª–∏. –ù–∞—á–∏–Ω–∞–µ–º —Å 0.
	updateOffset := 0

	fmt.Println("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω... (–°–ª—É—à–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)")
	// –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
	for {
		updates, err := client.GetUpdates(updateOffset)
		if err != nil {
			log.Printf("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: %v", err) //–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É, —Ç–æ–ª—å–∫–æ —Å –ø–æ–º–æ—â—å—é log
		}

		// 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º "–ø–∞—á–∫—É" –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
		for _, update := range updates {
			// –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à "–æ–±—Ä–∞–±–æ—Ç—á–∏–∫"
			if err := processUpdate(client, update); err != nil {
				log.Printf("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: %v", err)
			}

			// üí° –ù–Æ–ê–ù–° 5: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
			// –ú—ã –≥–æ–≤–æ—Ä–∏–º: "–û–ö, —è –≤–∏–¥–µ–ª —ç—Ç–æ (update.ID).
			// –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –¥–∞–π –º–Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ù–ê–ß–ò–ù–ê–Ø –° (update.ID + 1)"
			updateOffset = update.ID + 1
		}

		// üí° –ù–Æ–ê–ù–° 6: –°–æ–Ω
		// –ú—ã –Ω–µ —Ö–æ—Ç–∏–º "—Å–ø–∞–º–∏—Ç—å" Telegram 1000 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É.
		// "–ü–æ—Å–ø–∏–º" 1 —Å–µ–∫—É–Ω–¥—É –∏ –ø–æ–π–¥–µ–º –Ω–∞ –Ω–æ–≤—ã–π –∫—Ä—É–≥.
		time.Sleep(1 * time.Second)
	}
}

func processUpdate(client *telegram.Client, update telegram.Update) error {
	chatID := update.Message.Chat.ID
	text := update.Message.Text

	command := strings.TrimSpace(strings.ToLower(text)) //–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã —Å –∫–æ–Ω—Ü–æ–≤
	responseText := ""

	switch command {
	case "/start":
		responseText = "–ó–¥—Ä–∞—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞ –°–µ—Ä–∞—Ñ–∏–º—ã. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: \n\n/price - –ü–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç\n/links - –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ü—Å–µ—Ç–∏"
	case "/price":
		responseText = "‚≠êÔ∏è **–ü—Ä–∞–π—Å-–ª–∏—Å—Ç –Ω–∞ —É—Å–ª—É–≥–∏ (–ò–ü)** ‚≠êÔ∏è\n\n1. –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ 3-–ù–î–§–õ: –æ—Ç 1500 —Ä—É–±.\n2. –í–µ–¥–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –û–û–û (–£–°–ù): –æ—Ç 8000 —Ä—É–±./–º–µ—Å.\n3. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞: 1000 —Ä—É–±."
	case "/links":
		responseText = "üîó **–ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã**\n\n* Telegram/WhatsApp: [–ù–û–ú–ï–†]\n* Instagram: @[–ù–ò–ö–ù–ï–ô–ú]\n* –°–∞–π—Ç: [–°–°–´–õ–ö–ê_–ù–ê_–°–ê–ô–¢]"
	default:
		responseText = "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –≤–∞—Å –Ω–µ –ø–æ–Ω—è–ª. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –Ω–∞–±–µ—Ä–∏—Ç–µ /start"
	}
	return client.SendMessage(chatID, responseText)
}
